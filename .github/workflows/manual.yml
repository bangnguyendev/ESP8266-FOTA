name: Compare Versions

on:
  push:
    branches:
      - master

jobs:
  compare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install jq for JSON processing
        run: sudo apt-get install jq

      - name: Extract versions from JSON and header files
        id: extract_versions
        run: |
          json_version=$(jq -r '.main.version' include/Info_prod.json)
          header_version=$(awk -F '"' '/FirmwareVer/{print $2}' include/Macro_define.h)
          echo "${json_version}" >> $GITHUB_STATE
          echo "${header_version}" >> $GITHUB_STATE

      - name: Compare versions
        run: |
          if [ "${{ steps.extract_versions.outputs.json_version }}" == "${{ steps.extract_versions.outputs.header_version }}" ]; then
            echo "Versions match: ${{ steps.extract_versions.outputs.json_version }}"
          else
            echo "Versions do not match"
            exit 1
          fi

      - name: Set output
        if: failure()
        run: echo "Versions do not match" >> $GITHUB_OUTPUT
